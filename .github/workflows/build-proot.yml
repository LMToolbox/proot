name: Build PRoot for Android

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [arm64-v8a, x86_64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Android NDK
        uses: android-actions/setup-android@v3
        with:
          packages: 'ndk;28.2.13676358'

      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y make git

      - name: Clone PRoot
        run: git clone https://github.com/proot-me/proot -b master

      - name: Build PRoot and CARE
        run: |
          cd proot/src

          # Detect target triplet
          case "${{ matrix.abi }}" in
            arm64-v8a)
              TARGET=aarch64-linux-android
              ARCH=arm64
              API=24
              ;;
            x86_64)
              TARGET=x86_64-linux-android
              ARCH=x86_64
              API=24
              ;;
          esac

          PREFIX=$(pwd)/build/install

          # Find NDK clang
          NDK_DIR=$(ls -d $ANDROID_SDK_ROOT/ndk/* | sort -V | tail -n1)
          TOOLCHAIN=$NDK_DIR/toolchains/llvm/prebuilt/linux-x86_64/bin

          # Build talloc
          export CROSS_COMPILE=${TOOLCHAIN}/${TARGET}${API}-
          export CC=${TOOLCHAIN}/${TARGET}${API}-clang
          export CXX=${TOOLCHAIN}/${TARGET}${API}-clang++
          export AR=${TOOLCHAIN}/llvm-ar
          export RANLIB=${TOOLCHAIN}/llvm-ranlib
          export STRIP=${TOOLCHAIN}/llvm-strip

          export CFLAGS="--sysroot=$NDK_DIR/platforms/android-${API}/arch-${ARCH} -fPIC"
          export LDFLAGS="--sysroot=$NDK_DIR/platforms/android-${API}/arch-${ARCH}"

          git clone --depth 1 https://gitlab.com/samba-team/samba.git
          cd samba/lib/talloc
          python3 waf configure --prefix=$PREFIX --destdir=$PREFIX
          python3 waf build
          python3 waf install


          # Symlink tools
          ln -sf ${TOOLCHAIN}/${TARGET}${API}-clang  ${TOOLCHAIN}/${TARGET}${API}-gcc
          ln -sf ${TOOLCHAIN}/${TARGET}${API}-clang++ ${TOOLCHAIN}/${TARGET}${API}-g++
          ln -sf ${TOOLCHAIN}/llvm-strip ${TOOLCHAIN}/${TARGET}${API}-strip
          export PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig:$PKG_CONFIG_PATH
          # Make
          make loader.elf loader-m32.elf build.h
          make proot care

          # Copy executables to dist folder
          mkdir -p ../../dist/${{ matrix.abi }}
          cp proot ../../dist/${{ matrix.abi }}/
          cp care ../../dist/${{ matrix.abi }}/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: proot-android-${{ matrix.abi }}
          path: dist/${{ matrix.abi }}/
