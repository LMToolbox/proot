name: Build PRoot for Android

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [arm64, x86_64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r28c

      - name: Download dependencies
        run: |
          mkdir -p deps
          cd deps
          # libarchive
          git clone https://github.com/libarchive/libarchive.git -b v3.8.1
          # libtalloc
          curl -LO https://www.samba.org/ftp/talloc/talloc-2.4.3.tar.gz
          tar xzf talloc-2.4.3.tar.gz
          mv talloc-2.4.3 talloc
          # uthash
          git clone https://github.com/troydhanson/uthash.git -b v2.3.0 

      - name: Build and install dependencies
        env:
          ANDROID_NDK: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          $ANDROID_NDK/build/tools/make_standalone_toolchain.py \
            --arch ${{ matrix.arch }} \
            --api 24 \
            --install-dir /tmp/my-ndk-toolchain
            
          export PATH=/tmp/my-ndk-toolchain/bin:$PATH
          export CC=${{ matrix.arch }}-linux-android-gcc
          export CXX=${{ matrix.arch }}-linux-android-g++
          export SYSROOT=/tmp/my-ndk-toolchain/sysroot

          # Build libarchive
          cd deps/libarchive



      - name: Build PRoot and CARE
        run: |
          cd proot/src

          # Detect target triplet
          case "${{ matrix.abi }}" in
            arm64-v8a)
              TARGET=aarch64-linux-android
              ARCH=arm64
              API=24
              ;;
            x86_64)
              TARGET=x86_64-linux-android
              ARCH=x86_64
              API=24
              ;;
          esac

          PREFIX=$(pwd)/build/install

          # Find NDK clang
          NDK_DIR=$(ls -d $ANDROID_SDK_ROOT/ndk/* | sort -V | tail -n1)
          TOOLCHAIN=$NDK_DIR/toolchains/llvm/prebuilt/linux-x86_64/bin

          # Build talloc
          export CROSS_COMPILE=${TOOLCHAIN}/${TARGET}${API}-

          # Symlink tools
          ln -sf ${TOOLCHAIN}/${TARGET}${API}-clang  ${TOOLCHAIN}/${TARGET}${API}-gcc
          ln -sf ${TOOLCHAIN}/${TARGET}${API}-clang++ ${TOOLCHAIN}/${TARGET}${API}-g++
          ln -sf ${TOOLCHAIN}/llvm-strip ${TOOLCHAIN}/${TARGET}${API}-strip
          export PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig:$PKG_CONFIG_PATH
          # Make
          make loader.elf loader-m32.elf build.h
          make proot care

          # Copy executables to dist folder
          mkdir -p ../../dist/${{ matrix.abi }}
          cp proot ../../dist/${{ matrix.abi }}/
          cp care ../../dist/${{ matrix.abi }}/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: proot-android-${{ matrix.abi }}
          path: dist/${{ matrix.abi }}/
